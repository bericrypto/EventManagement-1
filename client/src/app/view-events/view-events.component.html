<div class="container py-4">
    <h1 class="display-5 fw-bold text-center mb-4 text-primary">Manage Events</h1>
 
    <!-- Search Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form [formGroup]="itemForm" (ngSubmit)="searchEvent()" class="mb-0">
                <div class="input-group">
                    <input type="text" formControlName="searchTerm" class="form-control" placeholder="Search With ID or Title">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>

    <div *ngIf="message" class="alert mt-3"
        [ngClass]="{'alert-success': message.type === 'success', 'alert-danger': message.type === 'error'}"
        role="alert">
        {{ message.text }}
    </div>
    <!-- Events Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                <h4 class="card-title mb-0">Events</h4>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <!-- Bookings button for PLANNER -->
                    <button *ngIf="roleName === 'PLANNER'" class="btn btn-info" (click)="viewAllBookings()">
                        <i class="bi bi-calendar-check"></i> View Bookings
                    </button>
                    <div>
                        <label for="sort" class="me-2 mb-0">Sort By:</label>
                        <select id="sort" (change)="onSortChange($event)" class="form-select d-inline-block w-auto">
                            <option value="id">ID</option>
                            <option value="title">Title</option>
                            <option value="date">Date</option>
                            <option value="location">Location</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter" class="me-2 mb-0">Filter:</label>
                        <select id="filter" (change)="onFilterChange($event)" class="form-select d-inline-block w-auto">
                            <option value="all">All Events</option>
                            <option value="past">Past Events</option>
                            <option value="today">Today's Events</option>
                            <option value="future">Future Events</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Title</th>
                            <th scope="col">Description</th>
                            <th scope="col">Date</th>
                            <th scope="col">Location</th>
                            <th scope="col">Status</th>
                            <th scope="col">Allocated Resources</th>
                            <th scope="col" *ngIf="roleName === 'PLANNER'">Assigned Staff</th>
                            <th scope="col" *ngIf="roleName === 'PLANNER' || roleName === 'CLIENT' || roleName === 'STAFF'">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let event of paginatedEvents">
                            <td>{{ event.eventID }}</td>
                            <td>{{ event.title }}</td>
                            <td>{{ event.description }}</td>
                            <td>{{ event.dateTime | date:'medium' }}</td>
                            <td>{{ event.location }}</td>
                            <td>
                                <span class="badge" 
                                    [ngClass]="{
                                        'bg-success': event.status === 'Scheduled',
                                        'bg-danger': event.status === 'Cancelled',
                                        'bg-secondary': event.status === 'Completed'
                                    }">
                                    {{ event.status }}
                                </span>
                            </td>
                            <td>
                                <div *ngIf="event.allocations && event.allocations.length > 0; else noResources">
                                    <div *ngFor="let allocation of event.allocations" class="mb-1">
                                        <small class="text-muted">
                                            <i class="bi bi-box-seam"></i>
                                            {{ allocation.resource?.name || 'N/A' }} 
                                            <span class="badge bg-info text-dark">Qty: {{ allocation.quantity }}</span>
                                        </small>
                                    </div>
                                </div>
                                <ng-template #noResources>
                                    <small class="text-muted fst-italic">No resources allocated</small>
                                </ng-template>
                            </td>
                            <td *ngIf="roleName === 'PLANNER'">
                                <span *ngIf="event.assignedStaff; else noStaff" class="badge bg-primary">
                                    {{ event.assignedStaff.fullName || event.assignedStaff.username }}
                                </span>
                                <ng-template #noStaff>
                                    <button class="btn btn-sm btn-secondary" 
                                            (click)="openStaffAssignment(event)">
                                        Assign Staff
                                    </button>
                                </ng-template>
                            </td>
                            <td *ngIf="roleName === 'PLANNER'">
                                <button class="btn btn-sm btn-primary me-1" (click)="openUpdateModal(event)">
                                    Update
                                </button>
                                <button class="btn btn-sm btn-info" 
                                        (click)="openMessaging(event)">
                                    Messages
                                </button>
                            </td>
                            <td *ngIf="roleName === 'CLIENT'">
                                <button class="btn btn-sm btn-success me-1" 
                                        (click)="openBookingForm(event)">
                                    Book Event
                                </button>
                                <button class="btn btn-sm btn-info" 
                                        (click)="openMessaging(event)">
                                    Messages
                                </button>
                            </td>
                            <td *ngIf="roleName === 'STAFF'">
                                <button class="btn btn-sm btn-info" 
                                        (click)="openMessaging(event)">
                                    Messages
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <button class="btn btn-outline-primary" (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
                <span class="text-muted">Page {{ currentPage }} of {{ totalPages }}</span>
                <button class="btn btn-outline-primary" (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Modal -->
<div class="custom-modal-overlay" *ngIf="showUpdateModal" (click)="closeUpdateModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>{{ isUpdate ? 'Update Event' : 'Create Event' }}</h5>
                <button type="button" class="btn-close" (click)="closeUpdateModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
                    
                    <div class="form-group mb-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" id="title" formControlName="title" class="form-control" />
                        <div *ngIf="itemForm.get('title')?.hasError('required') && itemForm.get('title')?.touched"
                            class="text-danger small mt-1">
                            Title is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description:</label>
                        <textarea id="description" formControlName="description" class="form-control" rows="3"></textarea>
                        <div *ngIf="itemForm.get('description')?.hasError('required') && itemForm.get('description')?.touched"
                            class="text-danger small mt-1">
                            Description is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="dateTime" class="form-label">Date Time:</label>
                        <input type="datetime-local" id="dateTime" formControlName="dateTime" class="form-control" />
                        <div *ngIf="itemForm.get('dateTime')?.hasError('required') && itemForm.get('dateTime')?.touched"
                            class="text-danger small mt-1">
                            Date and Time are required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="location" class="form-label">Location:</label>
                        <input type="text" id="location" formControlName="location" class="form-control" />
                        <div *ngIf="itemForm.get('location')?.hasError('required') && itemForm.get('location')?.touched"
                            class="text-danger small mt-1">
                            Location is required.
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="status" class="form-label">Status:</label>
                        <select id="status" class="form-select" formControlName="status">
                            <option value="" disabled selected>Select status</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <div *ngIf="itemForm.get('status')?.hasError('required') && itemForm.get('status')?.touched"
                            class="text-danger small mt-1">
                            Status is required.
                        </div>
                    </div>
                </form>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeUpdateModal()">Close</button>
                <button type="button" class="btn btn-primary" (click)="onSubmit()">
                    {{ isUpdate ? 'Update Event' : 'Create Event' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Staff Assignment Modal -->
<div class="custom-modal-overlay" *ngIf="showStaffAssignModal" (click)="closeStaffAssignModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Assign Staff to Event</h5>
                <button type="button" class="btn-close" (click)="closeStaffAssignModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForStaff">
                    <h6>Event: {{ selectedEventForStaff.title }}</h6>
                    <p class="text-muted small">{{ selectedEventForStaff.location }} - {{ selectedEventForStaff.dateTime | date:'medium' }}</p>
                    
                    <div class="form-group mb-3">
                        <label for="staffSelect" class="form-label">Select Staff Member:</label>
                        <select id="staffSelect" class="form-select" [(ngModel)]="selectedStaffId">
                            <option value="" disabled selected>Choose staff...</option>
                            <option *ngFor="let staff of staffList" [value]="staff.userId">
                                {{ staff.fullName || staff.username }} ({{ staff.email }})
                            </option>
                        </select>
                    </div>
                    
                    <div *ngIf="staffAssignMessage" class="alert" 
                         [ngClass]="{'alert-success': staffAssignSuccess, 'alert-danger': !staffAssignSuccess}">
                        {{ staffAssignMessage }}
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeStaffAssignModal()">Close</button>
                <button type="button" class="btn btn-primary" (click)="assignStaff()" [disabled]="!selectedStaffId">
                    Assign Staff
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Messaging Modal -->
<div class="custom-modal-overlay" *ngIf="showMessagingModal" (click)="closeMessagingModal()">
    <div class="custom-modal-dialog custom-modal-lg" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Event Messages</h5>
                <button type="button" class="btn-close" (click)="closeMessagingModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForMessaging">
                    <h6>Event: {{ selectedEventForMessaging.title }}</h6>
                    <hr>
                    
                    <!-- Messages Display -->
                    <div class="messages-container" style="max-height: 400px; overflow-y: auto;">
                        <div *ngIf="messages.length === 0" class="text-center text-muted py-4">
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                        <div *ngFor="let msg of messages" class="message mb-3">
                            <div class="d-flex" [ngClass]="{'justify-content-end': msg.senderRole === roleName}">
                                <div class="message-bubble p-3 rounded" 
                                     [ngClass]="{'bg-primary text-white': msg.senderRole === roleName, 'bg-light': msg.senderRole !== roleName}"
                                     style="max-width: 70%;">
                                    <strong>{{ msg.sender.fullName || msg.sender.username }}</strong>
                                    <small class="d-block text-muted" [ngClass]="{'text-white-50': msg.senderRole === roleName}">
                                        {{ msg.senderRole }}
                                    </small>
                                    <p class="mb-1 mt-2">{{ msg.content }}</p>
                                    <small class="text-muted" [ngClass]="{'text-white-50': msg.senderRole === roleName}">
                                        {{ msg.sentAt | date:'short' }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" [(ngModel)]="newMessage" 
                                   placeholder="Type your message..." (keyup.enter)="sendMessage()">
                            <button class="btn btn-primary" (click)="sendMessage()" [disabled]="!newMessage">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal (for CLIENT) -->
<div class="custom-modal-overlay" *ngIf="showBookingModal" (click)="closeBookingModal()">
    <div class="custom-modal-dialog" (click)="$event.stopPropagation()">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5>Book Event</h5>
                <button type="button" class="btn-close" (click)="closeBookingModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div *ngIf="selectedEventForBooking">
                    <h6>{{ selectedEventForBooking.title }}</h6>
                    <p class="text-muted small">
                        <i class="bi bi-calendar"></i> {{ selectedEventForBooking.dateTime | date:'medium' }}<br>
                        <i class="bi bi-geo-alt"></i> {{ selectedEventForBooking.location }}
                    </p>
                    <p class="mb-3">{{ selectedEventForBooking.description }}</p>
                    
                    <div class="mb-3">
                        <label for="clientRequirements" class="form-label">Your Requirements:</label>
                        <textarea id="clientRequirements" class="form-control" rows="4" 
                                  [(ngModel)]="bookingRequirements" 
                                  placeholder="Please describe your specific requirements or preferences for this event..."></textarea>
                        <small class="text-muted">Optional: Add any special requests or requirements</small>
                    </div>
                    
                    <div *ngIf="bookingMessage" class="alert" 
                         [ngClass]="{'alert-success': bookingSuccess, 'alert-danger': !bookingSuccess}">
                        {{ bookingMessage }}
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeBookingModal()">Cancel</button>
                <button type="button" class="btn btn-success" (click)="submitBooking()">
                    Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bookings List Modal (for PLANNER) -->
<div *ngIf="showBookingsListModal" class="custom-modal-overlay" (click)="closeBookingsListModal()">
    <div class="custom-modal-content" (click)="$event.stopPropagation()" style="max-width: 900px;">
        <div class="custom-modal-header">
            <h5>All Booking Requests</h5>
            <button type="button" class="btn-close" (click)="closeBookingsListModal()"></button>
        </div>
        <div class="custom-modal-body">
            <div *ngIf="allBookings.length === 0" class="text-center py-4">
                <p class="text-muted">No bookings found.</p>
            </div>
            <div *ngIf="allBookings.length > 0" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Event Title</th>
                            <th>Client</th>
                            <th>Booking Date</th>
                            <th>Status</th>
                            <th>Requirements</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let booking of allBookings">
                            <td>{{ booking.bookingId }}</td>
                            <td>{{ booking.event?.title || 'N/A' }}</td>
                            <td>{{ booking.user?.username || 'N/A' }}</td>
                            <td>{{ booking.bookingDate | date:'short' }}</td>
                            <td>
                                <span [ngClass]="getBookingStatusClass(booking.status)">
                                    {{ booking.status }}
                                </span>
                            </td>
                            <td>
                                <small>{{ booking.clientRequirements || 'None' }}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" (click)="openBookingStatusUpdate(booking)">
                                    Update Status
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeBookingsListModal()">Close</button>
        </div>
    </div>
</div>

<!-- Booking Status Update Modal (for PLANNER) -->
<div *ngIf="showBookingStatusModal" class="custom-modal-overlay" (click)="closeBookingStatusModal()">
    <div class="custom-modal-content" (click)="$event.stopPropagation()">
        <div class="custom-modal-header">
            <h5>Update Booking Status</h5>
            <button type="button" class="btn-close" (click)="closeBookingStatusModal()"></button>
        </div>
        <div class="custom-modal-body">
            <div *ngIf="selectedBooking">
                <div class="mb-3">
                    <strong>Booking ID:</strong> {{ selectedBooking.bookingId }}<br>
                    <strong>Event:</strong> {{ selectedBooking.event?.title }}<br>
                    <strong>Client:</strong> {{ selectedBooking.user?.username }}<br>
                    <strong>Requirements:</strong> {{ selectedBooking.clientRequirements || 'None' }}
                </div>
                
                <div class="mb-3">
                    <label for="bookingStatus" class="form-label">Status</label>
                    <select id="bookingStatus" [(ngModel)]="bookingStatusUpdate" class="form-select">
                        <option value="PENDING">Pending</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="APPROVED">Approved</option>
                        <option value="REJECTED">Rejected</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="bookingNotes" class="form-label">Notes (Optional)</label>
                    <textarea id="bookingNotes" [(ngModel)]="bookingNotes" 
                              class="form-control" rows="3"
                              placeholder="Add any notes for the client..."></textarea>
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeBookingStatusModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="updateBookingStatus()">
                Update Status
            </button>
        </div>
    </div>
</div>
